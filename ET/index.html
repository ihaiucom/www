<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <meta name="author" content="ihaiu" />
    <title>ET学习笔记和资源收集</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="/stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/stylesheets/github-light.css" media="screen">
    <link type="text/css" rel="stylesheet" href="/stylesheets/offlintab-439.css">
    <link type="stylesheet" rel="stylesheet" href="/stylesheets/font-awesome.min.css">
    <!-- <link type="stylesheet" rel="stylesheet" href="/stylesheets/about-grid.css"> -->


    <!-- <link href="/feed/" rel="alternate" title="ihaiu" type="application/atom+xml" /> -->

    <link rel="shortcut icon" href="/assets/icon/favicon.ico" />

    <link href="/assets/icon/favicon.ico" type="image/x-icon" rel="shortcut icon bookmark" />
    <link rel="apple-touch-icon-precomposed" href="assets/icon/icon32.png">
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/icon/icon76.png">
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/icon/icon120.png">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/icon/icon152.png">

  <!-- 
  <script src="http://www.it165.net/statics/js//it165_pro.js" type="text/javascript"></script>
  <script type="text/javascript">SyntaxHighlighter.all();</script>
  -->


           
    <script type="text/javascript" src="/media/syntaxhighlighter_2.0.278/scripts/shCore.js"></script>
    <link type="text/css" rel="stylesheet" href="/media/syntaxhighlighter_2.0.278/styles/shCore.css"/>
    <link type="text/css" rel="stylesheet" href="/media/syntaxhighlighter_2.0.278/styles/shThemeDefault.css"/>


      

      

      

      

      

      
      <script type="text/javascript" src="/media/syntaxhighlighter_2.0.278/scripts/shBrushCSharp.js"></script>
      

      

      

      

      

      

      


      

      
      

      

      

      

      

      

      

      

      

      

      

      



    <script type="text/javascript">SyntaxHighlighter.all();</script>


   

  </head>

  <body>
    <section class="page-header">
      <a href="http://www.ihaiu.com" class="iconbtn"><h1 style="background-image: url('/assets/icon/icon76_white.png'); background-position: center center; background-repeat:no-repeat; height:76px; margin:0px;"></h1></a>
      <a href="http://www.ihaiu.com" class="iconbtn"><h1 class="project-name" >爱海游</h1></a>
      <h2 class="project-tagline">ihaiu.com</h2>
      <a href="/#content" class="btn">目录</a>
      <a href="/categories/#content" class="btn">分类</a>
     <!--  <a href="/guestbook/#content" class="btn">留言</a> -->
     <!--  <a href="/about/#content" class="btn">关于</a> -->
      <a href="/opensource/#content" class="btn">开源分享</a>
      <a href="/share/#content" class="btn">分享</a>
     <!--  <a href="/share/gameart#content" class="btn">游戏美术</a> -->
      <a href="/friendlylink/#content" class="btn">友情链接</a>
    </section>





    <section class="main-content" id="content">

      <h1>ET学习笔记和资源收集</h1>
      <article class="content">
        <section class="meta">
<span class="time">
  <time datetime="2018-03-31">2018-03-31</time>
</span>

 | 
<span class="categories">
  发布
  <a href="tencent://message/?uin=593705098" title="发布:大海明月 QQ:593705098" rel="author">大海明月</a>&nbsp;
  
  <a href="mailto:zengfeng75@qq.com" title="发布:大海明月 Email:zengfeng75@qq.com" rel="author">zengfeng75@qq.com</a>&nbsp;
  
</span>



 | 
<span class="categories">
  分类
  
  <a href="/categories/#ET学习笔记和资源收集" title="ET学习笔记和资源收集">ET学习笔记和资源收集</a>&nbsp;
  
</span>


 | 
<span class="tags">
  标签
  
  <a href="/tags/#Networking" title="Networking">Networking</a>&nbsp;
  
</span>

</section>
<section class="post">
<p><br />
<br /></p>
<h2 class="nav1">相关资源</h2>
<ul>



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://github.com/egametang/ET" draggable="false">
  <span class="title">ET Github (在README.md下有比较全的相关文档)</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.tinkingli.com/?p=147" draggable="false">
  <span class="title">ET框架如何用MAC开发 (配置相关环境)</span>
</a>
</li>



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.taikr.com/my/course/972" draggable="false">
  <span class="title">视频教程：肉饼老师主讲 </span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.taikr.com/course/972/task/27872/show" draggable="false">
  <span class="title">视频教程：肉饼老师主讲 任务7：ETServer端项目的熟悉与运行课时文档 (对于.NetCore，构建项目的讲解对于初次接触.NetCore有比较大的帮助 )</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.taikr.com/course/972/task/27874/show" draggable="false">
  <span class="title">视频教程：肉饼老师主讲 任务9：ET client端项目的熟悉与运行(极简使用ET)课时文档 (讲的一个坑，因为ET用的NET46版，所以需要在这里设置好)</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://blog.csdn.net/Norman_Lin" draggable="false">
  <span class="title">Norman_Lin 学习ET比较系列</span>
</a>
</li>


<br />
<br />
<br />


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.cnblogs.com/ken-io/p/dotnet-core-quickstart.html" draggable="false">
  <span class="title">.NET Core 快速入门教程系列 </span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://ken.io/serie/dotnet-core-quickstart" draggable="false">
  <span class="title">.NET Core 快速入门教程系列 </span>
</a>
</li>



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.cnblogs.com/dotnet-org-cn/p/7566724.html" draggable="false">
  <span class="title">.NET Core 遇到的一些坑 </span>
</a>
</li>

<br />
<br />
<br />

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://ourpalm.github.io/ILRuntime/public/v1/guide/index.html" draggable="false">
  <span class="title">ILRuntime </span>
</a>
</li>

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/liqingwen/p/6217475.html" draggable="false">
  <span class="title">[C#] 回眸 C# 的前世今生 - 见证 C# 6.0 的新语法特性 </span>
</a>
</li>

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/liqingwen/p/5859236.html" draggable="false">
  <span class="title">手把手带你将自己打造的类库丢到 NuGet 上</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/dotnet261010/category/1068098.html" draggable="false">
  <span class="title">随笔分类 - MONGODB</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/zxtceq/category/837493.html" draggable="false">
  <span class="title">随笔分类 - Mongodb数据库技术分布式</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/qq75077027/category/441114.html" draggable="false">
  <span class="title">随笔分类 - NoSQL</span>
</a>
</li>





<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.cnblogs.com/yaozhenfa/p/4574898.html" draggable="false">
  <span class="title">MongoDB for C#基础入门</span>
</a>
</li>






<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/zxtceq/category/798175.html" draggable="false">
  <span class="title">随笔分类 - Redis技术</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/operators/null-conditional-operators" draggable="false">
  <span class="title">C# 运算符</span>
</a>
</li>




<br />
<br />
<br />

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://msdn.microsoft.com/library/hh191443(vs.110).aspx" draggable="false">
  <span class="title">使用 Async 和 Await 的异步编程（C# 和 Visual Basic）</span>
</a>
</li>

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.cnblogs.com/landeanfen/p/4734252.html" draggable="false">
  <span class="title">C#基础系列——异步编程初探：async和await</span>
</a>
</li>

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/liqingwen/p/5831951.html" draggable="false">
  <span class="title">[C#] 走进异步编程的世界 - 开始接触 async/await</span>
</a>
</li>

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/liqingwen/p/5831951.html" draggable="false">
  <span class="title">[C#] 走进异步编程的世界 - 开始接触 async/await</span>
</a>
</li>

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/liqingwen/p/5844095.html" draggable="false">
  <span class="title">[C#] 走进异步编程的世界 - 剖析异步方法（上）</span>
</a>
</li>

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/liqingwen/p/5866241.html" draggable="false">
  <span class="title">[C#] 走进异步编程的世界 - 剖析异步方法（下）</span>
</a>
</li>



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/liqingwen/p/5868688.html" draggable="false">
  <span class="title">[C#] C# 知识回顾 - 表达式树 Expression Trees</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/liqingwen/p/5832322.html" draggable="false">
  <span class="title">[C#] 走进 LINQ 的世界</span>
</a>
</li>

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/liqingwen/p/5801249.html" draggable="false">
  <span class="title">[C#] 进阶 - LINQ 标准查询操作概述</span>
</a>
</li>




<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/liqingwen/p/5902587.html" draggable="false">
  <span class="title">反骨仔的 2016 年度全文目录索 (Linq 系列, 异步编程系列, 委托与事件系列)</span>
</a>
</li>






<br />
<br />
<br />


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/maxliu/archive/2012/08/03/2621088.html" draggable="false">
  <span class="title">.NET日志工具介绍 </span>
</a>
</li>




<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.cnblogs.com/TianFang/p/4003749.html" draggable="false">
  <span class="title">一个简单好用的日志框架NLog </span>
</a>
</li>

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://archive.codeplex.com/?p=sentinel" draggable="false">
  <span class="title">日志查看工具：sentinel </span>
</a>
</li>



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://archive.codeplex.com/?p=harvester" draggable="false">
  <span class="title">日志查看工具：harvester </span>
</a>
</li>


<br />
<br />
<br />


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.bejson.com/convert/json2csharp/@" draggable="false">
  <span class="title">在线工具： JSON转C#实体类 </span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.bejson.com/" draggable="false">
  <span class="title">在线工具： JSON格式化 </span>
</a>
</li>


<br />
<br />
<br />



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://github.com/mgravell/protobuf-net" draggable="false">
  <span class="title">protobuf-net </span>
</a>
</li>




<br />
<br />
<br />



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://blog.csdn.net/qq_36458268/article/details/56481069" draggable="false">
  <span class="title">Mac上使用VScode调试Unity</span>
</a>
</li>



<br />
<br />

<a target="_blank" contextmenu="thumb-menu" href="https://github.com/ihaiucom/ihaiu.blog/blob/gh-pages/mddoc/et.md" draggable="false">
  <span class="title">目录结构</span>
</a>



<!-- 

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/dflying/category/78087.html" draggable="false">
  <span class="title">NLog文章系列——系列文章目录以及简要介绍 </span>
</a>
</li>



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/dflying/archive/2006/12/05/583071.html" draggable="false">
  <span class="title">NLog文章系列——入门教程（上） </span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/dflying/archive/2006/12/06/584426.html" draggable="false">
  <span class="title">NLog文章系列——入门教程（中） </span>
</a>
</li>

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/dflying/archive/2006/12/07/585787.html" draggable="false">
  <span class="title">NLog文章系列——入门教程（下） </span>
</a>
</li>

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://www.cnblogs.com/dflying/archive/2006/12/08/586678.html" draggable="false">
  <span class="title">NLog文章系列——与Visual Studio集成 </span>
</a>
</li> -->


</ul>

<p><br />
<br /></p>
<h2 class="nav1">Session 消息包</h2>

<table>
  <thead>
    <tr>
      <th>长度</th>
      <th>1</th>
      <th>2</th>
      <th>data.length</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>类型</td>
      <td>byte</td>
      <td>ushort/int16</td>
      <td>byte[]</td>
    </tr>
    <tr>
      <td>描述</td>
      <td>flag</td>
      <td>opcode</td>
      <td>data</td>
    </tr>
  </tbody>
</table>

<pre>
// flag第一位为1表示这是rpc返回消息,否则交由MessageDispatcher分发
</pre>

<p><br />
<br /></p>
<h2 class="nav1">TChannel 消息包</h2>

<table>
  <thead>
    <tr>
      <th>长度</th>
      <th>2</th>
      <th>size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>类型</td>
      <td>ushort/int16</td>
      <td>List&lt;byte[]&gt;</td>
    </tr>
    <tr>
      <td>描述</td>
      <td>size</td>
      <td>packeBuffs</td>
    </tr>
  </tbody>
</table>

<pre>
packeBuffs[0] = flag:byte
packeBuffs[1] = opcode:ushort
packeBuffs[2] = data:byte[]

// size = sum(flag, opcode, data)
</pre>

<p><br />
<br /></p>
<h2 class="nav1">UDP 消息包</h2>

<h2 id="c2s-connect连接请求">C2S Connect连接请求</h2>

<table>
  <thead>
    <tr>
      <th>长度</th>
      <th>4</th>
      <th>4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>类型</td>
      <td>uint32</td>
      <td>uint32</td>
    </tr>
    <tr>
      <td>描述</td>
      <td>KcpProtocalType.SYN</td>
      <td>KChannel.Con (Client)</td>
    </tr>
  </tbody>
</table>

<h2 id="s2c-accept接受请求">S2C Accept接受请求</h2>

<table>
  <thead>
    <tr>
      <th>长度</th>
      <th>4</th>
      <th>4</th>
      <th>4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>类型</td>
      <td>uint32</td>
      <td>uint32</td>
      <td>uint32</td>
    </tr>
    <tr>
      <td>描述</td>
      <td>KcpProtocalType.ACK</td>
      <td>KChannel.Con (Client)</td>
      <td>KChannel.Con (Server)</td>
    </tr>
  </tbody>
</table>

<h2 id="disconnect断开连接">DisConnect断开连接</h2>

<table>
  <thead>
    <tr>
      <th>长度</th>
      <th>4</th>
      <th>4</th>
      <th>4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>类型</td>
      <td>uint32</td>
      <td>uint32</td>
      <td>uint32</td>
    </tr>
    <tr>
      <td>描述</td>
      <td>KcpProtocalType.FIN</td>
      <td>KChannel.Con</td>
      <td>KChannel.RemoteConn</td>
    </tr>
  </tbody>
</table>

<h2 id="分包消息">分包消息</h2>

<p>比较啰嗦，后面有空再写</p>

<p><br />
<br /></p>
<h2 class="nav1">类介绍</h2>

<ul>
  <li>LocationProxyComponentSystem: 非Location服的 代理，负责ActorComponent向LocationComponent的注册Add、查找Get、移除Remove、锁Lock、解锁UnLock</li>
</ul>

<p><br />
<br /></p>
<h2 class="nav1">添加Actor到Location服, 调用栈</h2>

<p>ActorComponent.AddLocation()</p>

<h3 id="actorcomponentex">ActorComponentEx</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">AddLocation</span><span class="p">(</span><span class="k">this</span> <span class="n">ActorComponent</span> <span class="n">self</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">await</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">LocationProxyComponent</span><span class="p">&gt;().</span><span class="nf">Add</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">Entity</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
		<span class="p">}</span>
</code></pre></div></div>

<h3 id="locationproxycomponentsystem">LocationProxyComponentSystem</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
		<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">long</span> <span class="n">key</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">Session</span> <span class="n">session</span> <span class="p">=</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">NetInnerComponent</span><span class="p">&gt;().</span><span class="nf">Get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">LocationAddress</span><span class="p">);</span>
			<span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="k">new</span> <span class="nf">ObjectAddRequest</span><span class="p">()</span> <span class="p">{</span> <span class="n">Key</span> <span class="p">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">AppId</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">AppId</span> <span class="p">});</span>
		<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>以下是Location服</p>
</blockquote>

<h3 id="objectaddrequesthandler">ObjectAddRequestHandler</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">,</span> <span class="n">ObjectAddRequest</span> <span class="n">message</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">ObjectAddResponse</span><span class="p">&gt;</span> <span class="n">reply</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ObjectAddResponse</span> <span class="n">response</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ObjectAddResponse</span><span class="p">();</span>
			<span class="k">try</span>
			<span class="p">{</span>
				<span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">LocationComponent</span><span class="p">&gt;().</span><span class="nf">Add</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">AppId</span><span class="p">);</span>
				<span class="nf">reply</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="nf">ReplyError</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
</code></pre></div></div>

<h3 id="locationcomponent">LocationComponent</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">long</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">appId</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="n">locations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">appId</span><span class="p">;</span>

			<span class="n">Log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"location add key: </span><span class="p">{</span><span class="n">key</span><span class="p">}</span><span class="s"> appid: </span><span class="p">{</span><span class="n">appId</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

			<span class="c1">// 更新db</span>
			<span class="c1">//await Game.Scene.GetComponent&lt;DBProxyComponent&gt;().Save(new Location(key, address));</span>
		<span class="p">}</span>


</code></pre></div></div>

<p><br />
<br /></p>
<h2 class="nav1">移除Actor从Location服, 调用栈</h2>

<p>ActorComponent.RemoveLocation()</p>

<h3 id="actorcomponentex-1">ActorComponentEx</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
		<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">RemoveLocation</span><span class="p">(</span><span class="k">this</span> <span class="n">ActorComponent</span> <span class="n">self</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">await</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">LocationProxyComponent</span><span class="p">&gt;().</span><span class="nf">Remove</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">Entity</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
		<span class="p">}</span>
</code></pre></div></div>

<h3 id="locationproxycomponentsystem-1">LocationProxyComponentSystem</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
		<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Remove</span><span class="p">(</span><span class="kt">long</span> <span class="n">key</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">Session</span> <span class="n">session</span> <span class="p">=</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">NetInnerComponent</span><span class="p">&gt;().</span><span class="nf">Get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">LocationAddress</span><span class="p">);</span>
			<span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="k">new</span> <span class="nf">ObjectRemoveRequest</span><span class="p">()</span> <span class="p">{</span> <span class="n">Key</span> <span class="p">=</span> <span class="n">key</span> <span class="p">});</span>
		<span class="p">}</span>

</code></pre></div></div>

<blockquote>
  <p>以下是Location服</p>
</blockquote>

<h3 id="objectremoverequesthandler">ObjectRemoveRequestHandler</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">,</span> <span class="n">ObjectRemoveRequest</span> <span class="n">message</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">ObjectRemoveResponse</span><span class="p">&gt;</span> <span class="n">reply</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ObjectRemoveResponse</span> <span class="n">response</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ObjectRemoveResponse</span><span class="p">();</span>
			<span class="k">try</span>
			<span class="p">{</span>
				<span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">LocationComponent</span><span class="p">&gt;().</span><span class="nf">Remove</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Key</span><span class="p">);</span>
				<span class="nf">reply</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="nf">ReplyError</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
</code></pre></div></div>

<h3 id="locationcomponent-1">LocationComponent</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
		<span class="k">public</span> <span class="k">void</span> <span class="nf">Remove</span><span class="p">(</span><span class="kt">long</span> <span class="n">key</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">Log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"location remove key: </span><span class="p">{</span><span class="n">key</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="n">locations</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
		<span class="p">}</span>


</code></pre></div></div>

<p><br />
<br /></p>
<h2 class="nav1">Actor向Location调锁LockAsync, 调用栈</h2>

<h3 id="locationproxycomponentsystem-2">LocationProxyComponentSystem</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		
		<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Lock</span><span class="p">(</span><span class="kt">long</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">time</span> <span class="p">=</span> <span class="m">1000</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">Session</span> <span class="n">session</span> <span class="p">=</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">NetInnerComponent</span><span class="p">&gt;().</span><span class="nf">Get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">LocationAddress</span><span class="p">);</span>
			<span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="k">new</span> <span class="nf">ObjectLockRequest</span><span class="p">()</span> <span class="p">{</span> <span class="n">Key</span> <span class="p">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">LockAppId</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">AppId</span><span class="p">,</span> <span class="n">Time</span> <span class="p">=</span> <span class="n">time</span> <span class="p">});</span>
		<span class="p">}</span>

</code></pre></div></div>

<blockquote>
  <p>以下是Location服</p>
</blockquote>

<h3 id="objectlockrequesthandler">ObjectLockRequestHandler</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">,</span> <span class="n">ObjectLockRequest</span> <span class="n">message</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">ObjectLockResponse</span><span class="p">&gt;</span> <span class="n">reply</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ObjectLockResponse</span> <span class="n">response</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ObjectLockResponse</span><span class="p">();</span>
			<span class="k">try</span>
			<span class="p">{</span>
				<span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">LocationComponent</span><span class="p">&gt;().</span><span class="nf">LockAsync</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">LockAppId</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">Time</span><span class="p">);</span>
				<span class="nf">reply</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="nf">ReplyError</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
</code></pre></div></div>

<h3 id="locationcomponent-2">LocationComponent</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
		

		<span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">LockAsync</span><span class="p">(</span><span class="kt">long</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">appId</span><span class="p">,</span> <span class="kt">int</span> <span class="n">time</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(!</span><span class="k">this</span><span class="p">.</span><span class="n">lockDict</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">appId</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">LocationLockTask</span> <span class="n">task</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LocationLockTask</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">appId</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nf">AddTask</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span>
		<span class="p">}</span>


</code></pre></div></div>

<p><br />
<br /></p>
<h2 class="nav1">Actor向Location解锁UnLock, 调用栈</h2>

<h3 id="locationproxycomponentsystem-3">LocationProxyComponentSystem</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		
		
		<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">UnLock</span><span class="p">(</span><span class="kt">long</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="k">value</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">Session</span> <span class="n">session</span> <span class="p">=</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">NetInnerComponent</span><span class="p">&gt;().</span><span class="nf">Get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">LocationAddress</span><span class="p">);</span>
			<span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="k">new</span> <span class="nf">ObjectUnLockRequest</span><span class="p">()</span> <span class="p">{</span> <span class="n">Key</span> <span class="p">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">UnLockAppId</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">AppId</span><span class="p">,</span> <span class="n">AppId</span> <span class="p">=</span> <span class="k">value</span><span class="p">});</span>
		<span class="p">}</span>

</code></pre></div></div>

<blockquote>
  <p>以下是Location服</p>
</blockquote>

<h3 id="objectunlockrequesthandler">ObjectUnLockRequestHandler</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		
		<span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">,</span> <span class="n">ObjectUnLockRequest</span> <span class="n">message</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">ObjectUnLockResponse</span><span class="p">&gt;</span> <span class="n">reply</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ObjectUnLockResponse</span> <span class="n">response</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ObjectUnLockResponse</span><span class="p">();</span>
			<span class="k">try</span>
			<span class="p">{</span>
				<span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">LocationComponent</span><span class="p">&gt;().</span><span class="nf">UpdateAndUnLock</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">UnLockAppId</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">AppId</span><span class="p">);</span>
				<span class="nf">reply</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="nf">ReplyError</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
</code></pre></div></div>

<h3 id="locationcomponent-3">LocationComponent</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
		
		<span class="k">public</span> <span class="k">void</span> <span class="nf">UpdateAndUnLock</span><span class="p">(</span><span class="kt">long</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unLockAppId</span><span class="p">,</span> <span class="kt">int</span> <span class="k">value</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">lockAppId</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="n">lockDict</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">out</span> <span class="n">lockAppId</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lockAppId</span> <span class="p">!=</span> <span class="n">unLockAppId</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">Log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">$"unlock appid is different </span><span class="p">{</span><span class="n">lockAppId</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">unLockAppId</span><span class="p">}</span><span class="s">"</span> <span class="p">);</span>
			<span class="p">}</span>
			<span class="n">Log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"location unlock key: </span><span class="p">{</span><span class="n">key</span><span class="p">}</span><span class="s"> unLockAppId: </span><span class="p">{</span><span class="n">unLockAppId</span><span class="p">}</span><span class="s"> new: </span><span class="p">{</span><span class="k">value</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="n">locations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nf">UnLock</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
		<span class="p">}</span>

</code></pre></div></div>

<p><br />
<br /></p>
<h2 class="nav1">Actor向Location获取锁GetAsync, 调用栈</h2>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
	<span class="p">[</span><span class="n">ObjectSystem</span><span class="p">]</span>
	<span class="k">public</span> <span class="k">class</span> <span class="nc">ActorProxyStartSystem</span> <span class="p">:</span> <span class="n">StartSystem</span><span class="p">&lt;</span><span class="n">ActorProxy</span><span class="p">&gt;</span>
	<span class="p">{</span>
		<span class="k">public</span> <span class="k">override</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">(</span><span class="n">ActorProxy</span> <span class="n">self</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">appId</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">LocationProxyComponent</span><span class="p">&gt;().</span><span class="nf">Get</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
			<span class="n">self</span><span class="p">.</span><span class="n">Address</span> <span class="p">=</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">StartConfigComponent</span><span class="p">&gt;().</span><span class="nf">Get</span><span class="p">(</span><span class="n">appId</span><span class="p">).</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">InnerConfig</span><span class="p">&gt;().</span><span class="n">IPEndPoint</span><span class="p">;</span>

			<span class="n">self</span><span class="p">.</span><span class="nf">UpdateAsync</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

</code></pre></div></div>

<h3 id="locationproxycomponentsystem-4">LocationProxyComponentSystem</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		
		
		<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">long</span> <span class="n">key</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">Session</span> <span class="n">session</span> <span class="p">=</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">NetInnerComponent</span><span class="p">&gt;().</span><span class="nf">Get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">LocationAddress</span><span class="p">);</span>
			<span class="n">ObjectGetResponse</span> <span class="n">response</span> <span class="p">=</span> <span class="p">(</span><span class="n">ObjectGetResponse</span><span class="p">)</span><span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="k">new</span> <span class="nf">ObjectGetRequest</span><span class="p">()</span> <span class="p">{</span> <span class="n">Key</span> <span class="p">=</span> <span class="n">key</span> <span class="p">});</span>
			<span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">AppId</span><span class="p">;</span>
		<span class="p">}</span>

</code></pre></div></div>

<blockquote>
  <p>以下是Location服</p>
</blockquote>

<h3 id="objectgetrequesthandler">ObjectGetRequestHandler</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">,</span> <span class="n">ObjectGetRequest</span> <span class="n">message</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">ObjectGetResponse</span><span class="p">&gt;</span> <span class="n">reply</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ObjectGetResponse</span> <span class="n">response</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ObjectGetResponse</span><span class="p">();</span>
			<span class="k">try</span>
			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">appId</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">LocationComponent</span><span class="p">&gt;().</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Key</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">appId</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">response</span><span class="p">.</span><span class="n">Error</span> <span class="p">=</span> <span class="n">ErrorCode</span><span class="p">.</span><span class="n">ERR_ActorLocationNotFound</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">response</span><span class="p">.</span><span class="n">AppId</span> <span class="p">=</span> <span class="n">appId</span><span class="p">;</span>
				<span class="nf">reply</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="nf">ReplyError</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
</code></pre></div></div>

<h3 id="locationcomponent-4">LocationComponent</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
		

		<span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">GetAsync</span><span class="p">(</span><span class="kt">long</span> <span class="n">key</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(!</span><span class="k">this</span><span class="p">.</span><span class="n">lockDict</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="n">locations</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">out</span> <span class="kt">int</span> <span class="n">location</span><span class="p">);</span>
				<span class="n">Log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"location get key: </span><span class="p">{</span><span class="n">key</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">location</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">LocationQueryTask</span> <span class="n">task</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LocationQueryTask</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nf">AddTask</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">task</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span>
		<span class="p">}</span>


</code></pre></div></div>

<p><br />
<br /></p>
<h2 class="nav1">Actor派发消息, 调用栈</h2>

<h3 id="session">Session</h3>

<blockquote>
  <p>this.Network.MessageDispatcher.Dispatch(this, packet);</p>
</blockquote>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
		<span class="k">private</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="n">Packet</span> <span class="n">packet</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="p">.</span><span class="n">Length</span> <span class="p">&lt;</span> <span class="n">Packet</span><span class="p">.</span><span class="n">MinSize</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">Log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">$"message error length &lt; </span><span class="p">{</span><span class="n">Packet</span><span class="p">.</span><span class="n">MinSize</span><span class="p">}</span><span class="s">, ip: </span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="n">RemoteAddress</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
				<span class="k">this</span><span class="p">.</span><span class="n">Network</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="kt">byte</span> <span class="n">flag</span> <span class="p">=</span> <span class="n">packet</span><span class="p">.</span><span class="nf">Flag</span><span class="p">();</span>
			<span class="kt">ushort</span> <span class="n">opcode</span> <span class="p">=</span> <span class="n">packet</span><span class="p">.</span><span class="nf">Opcode</span><span class="p">();</span>

<span class="cp">#if !SERVER
</span>			<span class="k">if</span> <span class="p">(</span><span class="n">OpcodeHelper</span><span class="p">.</span><span class="nf">IsClientHotfixMessage</span><span class="p">(</span><span class="n">opcode</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="n">Network</span><span class="p">.</span><span class="n">MessageDispatcher</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif
</span>
			<span class="c1">// flag第一位为1表示这是rpc返回消息,否则交由MessageDispatcher分发</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">flag</span> <span class="p">&amp;</span> <span class="m">0x01</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="n">Network</span><span class="p">.</span><span class="n">MessageDispatcher</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="n">OpcodeTypeComponent</span> <span class="n">opcodeTypeComponent</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Network</span><span class="p">.</span><span class="n">Entity</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">OpcodeTypeComponent</span><span class="p">&gt;();</span>
			<span class="n">Type</span> <span class="n">responseType</span> <span class="p">=</span> <span class="n">opcodeTypeComponent</span><span class="p">.</span><span class="nf">GetType</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>
			<span class="kt">object</span> <span class="n">message</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Network</span><span class="p">.</span><span class="n">MessagePacker</span><span class="p">.</span><span class="nf">DeserializeFrom</span><span class="p">(</span><span class="n">responseType</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">Bytes</span><span class="p">,</span> <span class="n">Packet</span><span class="p">.</span><span class="n">Index</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">Packet</span><span class="p">.</span><span class="n">Index</span><span class="p">);</span>
			<span class="c1">//Log.Debug($"recv: {JsonHelper.ToJson(message)}");</span>

			<span class="n">IResponse</span> <span class="n">response</span> <span class="p">=</span> <span class="n">message</span> <span class="k">as</span> <span class="n">IResponse</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"flag is response, but message is not! </span><span class="p">{</span><span class="n">opcode</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">Action</span><span class="p">&lt;</span><span class="n">IResponse</span><span class="p">&gt;</span> <span class="n">action</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(!</span><span class="k">this</span><span class="p">.</span><span class="n">requestCallback</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">RpcId</span><span class="p">,</span> <span class="k">out</span> <span class="n">action</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">this</span><span class="p">.</span><span class="n">requestCallback</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">RpcId</span><span class="p">);</span>

			<span class="nf">action</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
		<span class="p">}</span>
</code></pre></div></div>

<h3 id="innermessagedispatcher">InnerMessageDispatcher</h3>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
	<span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// 服务器与服务器执行的消息通信派发</span>
    <span class="c1">/// &lt;/summary&gt;</span>
	<span class="k">public</span> <span class="k">class</span> <span class="nc">InnerMessageDispatcher</span><span class="p">:</span> <span class="n">IMessageDispatcher</span>
	<span class="p">{</span>
		<span class="k">public</span> <span class="k">void</span> <span class="nf">Dispatch</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">,</span> <span class="n">Packet</span> <span class="n">packet</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">ushort</span> <span class="n">opcode</span> <span class="p">=</span> <span class="n">packet</span><span class="p">.</span><span class="nf">Opcode</span><span class="p">();</span>
			<span class="n">Type</span> <span class="n">messageType</span> <span class="p">=</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">OpcodeTypeComponent</span><span class="p">&gt;().</span><span class="nf">GetType</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>
			<span class="n">IMessage</span> <span class="n">message</span> <span class="p">=</span> <span class="p">(</span><span class="n">IMessage</span><span class="p">)</span><span class="n">session</span><span class="p">.</span><span class="n">Network</span><span class="p">.</span><span class="n">MessagePacker</span><span class="p">.</span><span class="nf">DeserializeFrom</span><span class="p">(</span><span class="n">messageType</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">Bytes</span><span class="p">,</span> <span class="n">Packet</span><span class="p">.</span><span class="n">Index</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">Packet</span><span class="p">.</span><span class="n">Index</span><span class="p">);</span>
			
			<span class="c1">// 收到actor消息,放入actor队列</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="k">is</span> <span class="n">IActorMessage</span> <span class="n">iActorMessage</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">Entity</span> <span class="n">entity</span> <span class="p">=</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">ActorManagerComponent</span><span class="p">&gt;().</span><span class="nf">Get</span><span class="p">(</span><span class="n">iActorMessage</span><span class="p">.</span><span class="n">ActorId</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">entity</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Log</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">$"not found actor: </span><span class="p">{</span><span class="n">iActorMessage</span><span class="p">.</span><span class="n">ActorId</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
					<span class="n">ActorResponse</span> <span class="n">response</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActorResponse</span>
					<span class="p">{</span>
						<span class="n">Error</span> <span class="p">=</span> <span class="n">ErrorCode</span><span class="p">.</span><span class="n">ERR_NotFoundActor</span><span class="p">,</span>
						<span class="n">RpcId</span> <span class="p">=</span> <span class="n">iActorMessage</span><span class="p">.</span><span class="n">RpcId</span>
					<span class="p">};</span>
					<span class="n">session</span><span class="p">.</span><span class="nf">Reply</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				
				<span class="n">entity</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">ActorComponent</span><span class="p">&gt;().</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">ActorMessageInfo</span><span class="p">()</span> <span class="p">{</span> <span class="n">Session</span> <span class="p">=</span> <span class="n">session</span><span class="p">,</span> <span class="n">Message</span> <span class="p">=</span> <span class="n">iActorMessage</span> <span class="p">});</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">MessageDispatherComponent</span><span class="p">&gt;().</span><span class="nf">Handle</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="k">new</span> <span class="nf">MessageInfo</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="n">message</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
</code></pre></div></div>

<h3 id="actorcomponentex-2">ActorComponentEx</h3>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	
        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 将消息添加到队列</span>
        <span class="c1">/// 如果有处理任务在等待消息，就将该消息从队列里拿出来丢给它执行</span>
        <span class="c1">/// &lt;/summary&gt;</span>
		<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="k">this</span> <span class="n">ActorComponent</span> <span class="n">self</span><span class="p">,</span> <span class="n">ActorMessageInfo</span> <span class="n">info</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tcs</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="kt">var</span> <span class="n">t</span> <span class="p">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tcs</span><span class="p">;</span>
			<span class="n">self</span><span class="p">.</span><span class="n">tcs</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
			<span class="n">t</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="nf">Dequeue</span><span class="p">());</span>
		<span class="p">}</span>
</code></pre></div></div>

<h3 id="actorcomponent-启动消息等待处理循环">ActorComponent 启动消息等待处理循环</h3>
<p>ActorComponent.Awake</p>

<h4 id="actorcomponentex-3">ActorComponentEx</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="p">[</span><span class="n">ObjectSystem</span><span class="p">]</span>
	<span class="k">public</span> <span class="k">class</span> <span class="nc">ActorComponentAwakeSystem</span> <span class="p">:</span> <span class="n">AwakeSystem</span><span class="p">&lt;</span><span class="n">ActorComponent</span><span class="p">&gt;</span>
	<span class="p">{</span>
		<span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">(</span><span class="n">ActorComponent</span> <span class="n">self</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">self</span><span class="p">.</span><span class="n">entityActorHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CommonEntityActorHandler</span><span class="p">();</span>
			<span class="n">self</span><span class="p">.</span><span class="n">queue</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">ActorMessageInfo</span><span class="p">&gt;();</span>
			<span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">ActorManagerComponent</span><span class="p">&gt;().</span><span class="nf">Add</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">Entity</span><span class="p">);</span>

			<span class="n">self</span><span class="p">.</span><span class="nf">HandleAsync</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="p">[</span><span class="n">ObjectSystem</span><span class="p">]</span>
	<span class="k">public</span> <span class="k">class</span> <span class="nc">ActorComponentAwake1System</span> <span class="p">:</span> <span class="n">AwakeSystem</span><span class="p">&lt;</span><span class="n">ActorComponent</span><span class="p">,</span> <span class="n">IEntityActorHandler</span><span class="p">&gt;</span>
	<span class="p">{</span>
		<span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">(</span><span class="n">ActorComponent</span> <span class="n">self</span><span class="p">,</span> <span class="n">IEntityActorHandler</span> <span class="n">iEntityActorHandler</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">self</span><span class="p">.</span><span class="n">entityActorHandler</span> <span class="p">=</span> <span class="n">iEntityActorHandler</span><span class="p">;</span>
			<span class="n">self</span><span class="p">.</span><span class="n">queue</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">ActorMessageInfo</span><span class="p">&gt;();</span>
			<span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">ActorManagerComponent</span><span class="p">&gt;().</span><span class="nf">Add</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">Entity</span><span class="p">);</span>

			<span class="n">self</span><span class="p">.</span><span class="nf">HandleAsync</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

</code></pre></div></div>

<h3 id="actorcomponentex-4">ActorComponentEx</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">HandleAsync</span><span class="p">(</span><span class="k">this</span> <span class="n">ActorComponent</span> <span class="n">self</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">IsDisposed</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">try</span>
				<span class="p">{</span>
					<span class="n">ActorMessageInfo</span> <span class="n">info</span> <span class="p">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">();</span>
                    <span class="c1">// 返回null表示actor已经删除,协程要终止, ActorComponent.Dispose发送的</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">Message</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">return</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">entityActorHandler</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">Session</span><span class="p">,</span> <span class="p">(</span><span class="n">Entity</span><span class="p">)</span><span class="n">self</span><span class="p">.</span><span class="n">Parent</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>


		<span class="k">private</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActorMessageInfo</span><span class="p">&gt;</span> <span class="nf">GetAsync</span><span class="p">(</span><span class="k">this</span> <span class="n">ActorComponent</span> <span class="n">self</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="nf">Dequeue</span><span class="p">());</span>
			<span class="p">}</span>

			<span class="n">self</span><span class="p">.</span><span class="n">tcs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="n">ActorMessageInfo</span><span class="p">&gt;();</span>
			<span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">tcs</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span>
		<span class="p">}</span>

</code></pre></div></div>

<h3 id="ientityactorhandler-派生类">IEntityActorHandler 派生类</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
	<span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// gate session收到的消息直接转发给客户端</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">GateSessionEntityActorHandler</span> <span class="p">:</span> <span class="n">IEntityActorHandler</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">,</span> <span class="n">Entity</span> <span class="n">entity</span><span class="p">,</span> <span class="n">IActorMessage</span> <span class="n">actorMessage</span><span class="p">)</span>
        <span class="p">{</span>
			<span class="n">ActorResponse</span> <span class="n">actorResponse</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActorResponse</span>
			<span class="p">{</span>
				<span class="n">RpcId</span> <span class="p">=</span> <span class="n">actorMessage</span><span class="p">.</span><span class="n">RpcId</span>
			<span class="p">};</span>
			<span class="k">try</span>
	        <span class="p">{</span>
		        <span class="c1">// 发送给客户端</span>
		        <span class="n">Session</span> <span class="n">clientSession</span> <span class="p">=</span> <span class="n">entity</span> <span class="k">as</span> <span class="n">Session</span><span class="p">;</span>
				<span class="n">clientSession</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="n">actorMessage</span><span class="p">);</span>

				<span class="n">session</span><span class="p">.</span><span class="nf">Reply</span><span class="p">(</span><span class="n">actorResponse</span><span class="p">);</span>
		        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
	        <span class="p">}</span>
	        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
	        <span class="p">{</span>
		        <span class="n">actorResponse</span><span class="p">.</span><span class="n">Error</span> <span class="p">=</span> <span class="n">ErrorCode</span><span class="p">.</span><span class="n">ERR_SessionActorError</span><span class="p">;</span>
		        <span class="n">actorResponse</span><span class="p">.</span><span class="n">Message</span> <span class="p">=</span> <span class="s">$"session actor error </span><span class="p">{</span><span class="n">e</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>
				<span class="n">session</span><span class="p">.</span><span class="nf">Reply</span><span class="p">(</span><span class="n">actorResponse</span><span class="p">);</span>
				<span class="k">throw</span><span class="p">;</span>
	        <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">CommonEntityActorHandler</span> <span class="p">:</span> <span class="n">IEntityActorHandler</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">,</span> <span class="n">Entity</span> <span class="n">entity</span><span class="p">,</span> <span class="n">IActorMessage</span> <span class="n">actorMessage</span><span class="p">)</span>
        <span class="p">{</span>
			<span class="k">await</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">ActorMessageDispatherComponent</span><span class="p">&gt;().</span><span class="nf">Handle</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">actorMessage</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// 玩家收到帧同步消息交给帧同步组件处理</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MapUnitEntityActorHandler</span> <span class="p">:</span> <span class="n">IEntityActorHandler</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">,</span> <span class="n">Entity</span> <span class="n">entity</span><span class="p">,</span> <span class="n">IActorMessage</span> <span class="n">actorMessage</span><span class="p">)</span>
        <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">actorMessage</span> <span class="k">is</span> <span class="n">OneFrameMessage</span> <span class="n">aFrameMessage</span><span class="p">)</span>
            <span class="p">{</span>
				<span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">ServerFrameComponent</span><span class="p">&gt;().</span><span class="nf">Add</span><span class="p">(</span><span class="n">aFrameMessage</span><span class="p">);</span>

				<span class="n">ActorResponse</span> <span class="n">actorResponse</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActorResponse</span>
				<span class="p">{</span>
					<span class="n">RpcId</span> <span class="p">=</span> <span class="n">actorMessage</span><span class="p">.</span><span class="n">RpcId</span>
				<span class="p">};</span>
				<span class="n">session</span><span class="p">.</span><span class="nf">Reply</span><span class="p">(</span><span class="n">actorResponse</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">await</span> <span class="n">Game</span><span class="p">.</span><span class="n">Scene</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">ActorMessageDispatherComponent</span><span class="p">&gt;().</span><span class="nf">Handle</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">actorMessage</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


</code></pre></div></div>

<h3 id="actormessagedispathercomponent-actor消息分发组件">ActorMessageDispatherComponent Actor消息分发组件</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
		<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">Session</span> <span class="n">session</span><span class="p">,</span> <span class="n">Entity</span> <span class="n">entity</span><span class="p">,</span> <span class="n">IActorMessage</span> <span class="n">actorRequest</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(!</span><span class="k">this</span><span class="p">.</span><span class="n">handlers</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">actorRequest</span><span class="p">.</span><span class="nf">GetType</span><span class="p">(),</span> <span class="k">out</span> <span class="n">IMActorHandler</span> <span class="n">handler</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"not found message handler: </span><span class="p">{</span><span class="n">MongoHelper</span><span class="p">.</span><span class="nf">ToJson</span><span class="p">(</span><span class="n">actorRequest</span><span class="p">)}</span><span class="s">"</span><span class="p">);</span>
			<span class="p">}</span>
			
			<span class="k">await</span> <span class="n">handler</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">actorRequest</span><span class="p">);</span>
		<span class="p">}</span>

</code></pre></div></div>

<h3 id="imactorhandler-派生类">IMActorHandler 派生类</h3>

<blockquote>
  <p>AMActorHandler&lt;E, Message&gt;: IMActorHandler where E: Entity where Message : class</p>
</blockquote>

<p>Actor_TestHandler</p>

<blockquote>
  <p>AMActorRpcHandler&lt;E, Request, Response&gt;: IMActorHandler where E: Entity where Request: class, IActorRequest where Response : class, IActorResponse</p>
</blockquote>

<p>Actor_TestRequestHandler
Actor_TransferHandler
C2M_TestActorRequestHandler</p>

</section>
<section class="page">

	 
  <span><a href="/ForgeNetworkingRemastered_FrameStream_Add_Field/#content" class="pageNav"  >上一篇: ForgeNetworkingRemastered 之 FreamStream添加属性并同步</a></span>
  <br/>
  

  
	<span><a href="/AStar/#content" class="pageNav"  >下一篇: 服务器使用AstarPathfindingProject的修改</a></span>
   

</section>


<div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
<script>
  var cloudTieConfig = {
    url: document.location.href, 
    sourceId: "201803311115",
    productKey: "97dc4b8e4aeb41ca8606d2c6efa6eae3",
    target: "cloud-tie-wrapper"
  };
</script>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>


      </article>


      <footer class="site-footer">

          <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?aa2fdee733dec8a2399b5bc0efbfd843";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

        <span class="site-footer-credits"><a href="http://www.ihaiu.com">爱海游</a></span> |
        <span class="site-footer-credits"><a href="http://blog.ihaiu.com">博客</a></span> |

        <script src="http://s4.cnzz.com/z_stat.php?id=1260003113&web_id=1260003113" language="JavaScript"></script>

        <p align="center">版权所有：©2021 ihaiu.com 版权所有ICP证： <a href="https://beian.miit.gov.cn/" target="_blank">沪ICP备2021002336号</a></p>
      </footer>

    </section>


  
  </body>
</html>


