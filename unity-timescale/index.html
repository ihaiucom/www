<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <meta name="author" content="ihaiu" />
    <title>Unity 防加速器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="/stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/stylesheets/github-light.css" media="screen">
    <link type="text/css" rel="stylesheet" href="/stylesheets/offlintab-439.css">
    <link type="stylesheet" rel="stylesheet" href="/stylesheets/font-awesome.min.css">
    <!-- <link type="stylesheet" rel="stylesheet" href="/stylesheets/about-grid.css"> -->


    <!-- <link href="/feed/" rel="alternate" title="ihaiu" type="application/atom+xml" /> -->

    <link rel="shortcut icon" href="/assets/icon/favicon.ico" />

    <link href="/assets/icon/favicon.ico" type="image/x-icon" rel="shortcut icon bookmark" />
    <link rel="apple-touch-icon-precomposed" href="assets/icon/icon32.png">
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/icon/icon76.png">
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/icon/icon120.png">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/icon/icon152.png">

  <!-- 
  <script src="http://www.it165.net/statics/js//it165_pro.js" type="text/javascript"></script>
  <script type="text/javascript">SyntaxHighlighter.all();</script>
  -->


           
    <script type="text/javascript" src="/media/syntaxhighlighter_2.0.278/scripts/shCore.js"></script>
    <link type="text/css" rel="stylesheet" href="/media/syntaxhighlighter_2.0.278/styles/shCore.css"/>
    <link type="text/css" rel="stylesheet" href="/media/syntaxhighlighter_2.0.278/styles/shThemeDefault.css"/>


      

      

      

      

      

      
      <script type="text/javascript" src="/media/syntaxhighlighter_2.0.278/scripts/shBrushCSharp.js"></script>
      

      

      

      

      

      

      


      

      
      

      

      

      

      

      

      

      

      

      

      

      



    <script type="text/javascript">SyntaxHighlighter.all();</script>


   

  </head>

  <body>
    <section class="page-header">
      <a href="http://www.ihaiu.com" class="iconbtn"><h1 style="background-image: url('/assets/icon/icon76_white.png'); background-position: center center; background-repeat:no-repeat; height:76px; margin:0px;"></h1></a>
      <a href="http://www.ihaiu.com" class="iconbtn"><h1 class="project-name" >爱海游</h1></a>
      <h2 class="project-tagline">ihaiu.com</h2>
      <a href="/#content" class="btn">目录</a>
      <a href="/categories/#content" class="btn">分类</a>
     <!--  <a href="/guestbook/#content" class="btn">留言</a> -->
     <!--  <a href="/about/#content" class="btn">关于</a> -->
      <a href="/opensource/#content" class="btn">开源分享</a>
      <a href="/share/#content" class="btn">分享</a>
     <!--  <a href="/share/gameart#content" class="btn">游戏美术</a> -->
      <a href="/friendlylink/#content" class="btn">友情链接</a>
    </section>





    <section class="main-content" id="content">

      <h1>Unity 防加速器</h1>
      <article class="content">
        <section class="meta">
<span class="time">
  <time datetime="2016-09-23">2016-09-23</time>
</span>

 | 
<span class="categories">
  发布
  <a href="tencent://message/?uin=593705098" title="发布:大海明月 QQ:593705098" rel="author">大海明月</a>&nbsp;
  
  <a href="mailto:zengfeng75@qq.com" title="发布:大海明月 Email:zengfeng75@qq.com" rel="author">zengfeng75@qq.com</a>&nbsp;
  
</span>



 | 
<span class="categories">
  分类
  
  <a href="/categories/#Unity" title="Unity">Unity</a>&nbsp;
  
</span>


 | 
<span class="tags">
  标签
  
  <a href="/tags/#Unity" title="Unity">Unity</a>&nbsp;
  
  <a href="/tags/#防加速器" title="防加速器">防加速器</a>&nbsp;
  
</span>

</section>
<section class="post">
<p><a href="https://pan.baidu.com/s/1hsO9r7I">防加速器Demo https://pan.baidu.com/s/1hsO9r7I</a></p>

<h2 class="nav1">思路</h2>
<p>"本地间隔时间"和“服务器间隔时间”做对比。就可以计算出变速器改变比例。我们再修改 <b>Time.timeScale</b>的值就可以还原本身速度</p>
<p>（时间戳为毫秒）</p>
<p></p>

<h2 class="nav1">获取本地时间</h2>
<p>使用“靠谱助手”模拟器的加速器测试，可以发现<b>Time.time</b>、<b>Time.unscaledTime</b>速度都会被改变。我们游戏中有可能会用到<b>Time.timeScale</b>,而他会改变<b>Time.time</b>的频率。所以我们用<b>Time.unscaledTime</b>来做参考</p>

<pre class="brush: csharp; ">
    private static double _time = 0;
    private static float _delayTime = 1;
    private static void UpdateLocalTime()
    {
        if (_time &gt; 0)
        {
            _delayTime = (float) (Time.unscaledTime - _time);
        }
        else
        {
            _delayTime = gapTimeConfig;
        }

        _time = Time.unscaledTime;
    }

    public static float delayTime
    {
        get
        {
            return _delayTime;
        }
    }
</pre>

<h2 class="nav1">获取服务器时间</h2>

<pre class="brush: csharp; ">
    private static double _preServerTime = -1;
    private static double _serverTime = -1;
    private static float   _delayServerTime = 1;
    private static WWW www;
    private static IEnumerator GetHtmlServerTime()
    {
        www = new WWW("http://192.168.1.7/time.php");
        yield return www;
        if (!string.IsNullOrEmpty(www.error))
        {
            yield break;
        }

        SetServerTime(Convert.ToDouble(www.text));
    }

    private static void SetServerTime(double time)
    {
        _serverTime = time;
        if (_preServerTime &gt; 0)
        {
            _delayServerTime = (float) (_serverTime - _preServerTime) / 1000;
        }
        else
        {
            _delayServerTime = gapTimeConfig;
        }
        _preServerTime = _serverTime;
    }
</pre>

<h2 class="nav1">计算加速度比例</h2>
<pre class="brush: csharp; ">
    float speedRate = delayTime / delayServerTime;
    float speedScale = Mathf.RoundToInt((1 / speedRate) * 10) / 10f;  // 10主要是为了排除通信时间
</pre>

<h2 class="nav1">我们自定义一个HTime用来修改 timeScale</h2>
<p>如果要修改timeScale，就使用我们自己定义的HTime.timeScale</p>

<pre class="brush: csharp; ">
    private static float _timeScale = 1;
    public static float timeScale
    {
        get
        {
            return _timeScale;
        }

        set
        {
            _timeScale = value;
            setTimeScale();
        }
    }

    public static void setTimeScale()
    {
        Time.timeScale = Mathf.Clamp(_timeScale * speedScale, 0f, 100f);
    }
</pre>

<h2 class="nav1">HTime</h2>

<pre class="brush: csharp; ">
using UnityEngine;
using System.Collections;
using System;

public class HTime 
{
    public static bool isAntiAccelerator = true;
    public static int gapTimeConfig = 2;
    private static DateTime dateTime1970 = new DateTime(1970, 1, 1, 0, 0, 0);
    public static double timeStamp
    {  
        get
        {
            return (DateTime.UtcNow - dateTime1970).TotalMilliseconds;  
        }
    }

    private static double _time = 0;
    private static float _delayTime = 1;
    private static void UpdateLocalTime()
    {
        if (_time &gt; 0)
        {
            _delayTime = (float) (Time.unscaledTime - _time);
        }
        else
        {
            _delayTime = gapTimeConfig;
        }

        _time = Time.unscaledTime;
    }

    public static float delayTime
    {
        get
        {
            return _delayTime;
        }
    }

    public static void CheckUpdateBegin()
    {
        UpdateLocalTime();
    }

    public static void CheckUpdateEnd(Int32 s, Int32 ms)
    {
        UpdateLocalTime();
        SetServerTime(s * 1000 + ms);
        if (isAntiAccelerator)
        {
            setTimeScale();
        }
    }


    private static void SetServerTime(double time)
    {
        _serverTime = time;
        if (_preServerTime &gt; 0)
        {
            _delayServerTime = (float) (_serverTime - _preServerTime) / 1000;
        }
        else
        {
            _delayServerTime = gapTimeConfig;
        }
        _preServerTime = _serverTime;
    }


    public static IEnumerator Check()
    {

        while (true)
        {
            UpdateLocalTime();
            yield return GetHtmlServerTime();
            yield return new WaitForSeconds(timeScale &gt; 0 ? gapTimeConfig / timeScale : gapTimeConfig);
            if (isAntiAccelerator)
            {
                setTimeScale();
            }
        }
    }




    private static double _preServerTime = -1;
    private static double _serverTime = -1;
    private static float   _delayServerTime = 1;
    private static WWW www;
    private static IEnumerator GetHtmlServerTime()
    {
        www = new WWW("http://192.168.1.7/time.php");
        yield return www;
        if (!string.IsNullOrEmpty(www.error))
        {
            yield break;
        }

        SetServerTime(Convert.ToDouble(www.text));
    }


    public static float delayServerTime
    {
        get
        {
            return _delayServerTime;
        }
    }

    public static float speedRate
    {
        get
        {
            return delayTime / delayServerTime;
        }
    }

    public static float speedScale
    {
        get
        {
            return Mathf.RoundToInt((1 / speedRate) * 10) / 10f;
        }
    }

    private static float _timeScale = 1;
    public static float timeScale
    {
        get
        {
            return _timeScale;
        }

        set
        {
            _timeScale = value;
            setTimeScale();
        }
    }

    public static void setTimeScale()
    {
        Time.timeScale = Mathf.Clamp(_timeScale * speedScale, 0f, 100f);
    }

    public static void Reset()
    {
        _delayTime = gapTimeConfig;
        _delayServerTime = gapTimeConfig;
        setTimeScale();
    }
        





}
</pre>

<h2 class="nav1">测试</h2>

<pre class="brush: csharp; ">
using UnityEngine;
using System.Collections;
using UnityEngine.UI;
using System;

public class TimeInfo : MonoBehaviour {

    public Text text;
    private string info;

    public Toggle fangToggle;
    public Toggle appToggle;
    public Slider slider;
    public InputField minInput;
    public InputField maxInput;
    public Text       currText;

   
    void Start ()
    {
        fangToggle.isOn = HTime.isAntiAccelerator;
        StartCoroutine(HTime.Check());
    }
    
    void Update () 
    {
        info = "";
        info += string.Format("Time.timeScale = {0} \n", Time.timeScale);
        info += string.Format("Time.time = {0} \n", Time.time);
        info += string.Format("Time.unscaledTime = {0} \n", Time.unscaledTime);
        info += string.Format("Time.deltaTime = {0} \n", Time.deltaTime);
        info += string.Format("Time.unscaledDeltaTime = {0} \n", Time.unscaledDeltaTime);
        info += string.Format("Time.smoothDeltaTime = {0} \n", Time.smoothDeltaTime);
        info += string.Format("Time.fixedTime = {0} \n", Time.fixedTime);
        info += string.Format("Time.fixedDeltaTime = {0} \n", Time.fixedDeltaTime);
        info += string.Format("Time.timeSinceLevelLoad = {0} \n", Time.timeSinceLevelLoad);
        info += string.Format("Time.realtimeSinceStartup = {0} \n", Time.realtimeSinceStartup);
        info += string.Format("Time.frameCount = {0} \n", Time.frameCount);
        info += string.Format("Time.captureFramerate = {0} \n", Time.captureFramerate);

        info += string.Format("HTime.timeStamp = {0} \n", HTime.timeStamp);
        info += string.Format("HTime.gapTimeConfig = {0} \n", HTime.gapTimeConfig);
        info += string.Format("HTime.delayTime = {0} \n", HTime.delayTime);
        info += string.Format("HTime.delayServerTime = {0} \n", HTime.delayServerTime);
        info += string.Format("HTime.speedRate = {0} \n", HTime.speedRate);
        info += string.Format("HTime.speedScale = {0} \n", HTime.speedScale);
        info += string.Format("HTime.timeScale = {0} \n", HTime.timeScale);
        text.text = info;

        slider.minValue = Convert.ToSingle(minInput.text);
        slider.maxValue = Convert.ToSingle(maxInput.text);
        currText.text = slider.value + "";


        HTime.isAntiAccelerator = fangToggle.isOn;
        if (appToggle.isOn)
        {
            HTime.timeScale = slider.value;
        }
    }


    public void Open()
    {
        gameObject.SetActive(true);
    }

    public void Close()
    {
        gameObject.SetActive(false);
    }

}

</pre>

<p><a href="https://pan.baidu.com/s/1hsO9r7I">防加速器Demo https://pan.baidu.com/s/1hsO9r7I</a></p>


</section>
<section class="page">

	 
  <span><a href="/android_sdk/#content" class="pageNav"  >上一篇: Android SDK 更新镜像服务器</a></span>
  <br/>
  

  
	<span><a href="/shell_awk_print/#content" class="pageNav"  >下一篇: 【笔记】Mac Shell awk '{print $column}' 打印第column列</a></span>
   

</section>


<div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
<script>
  var cloudTieConfig = {
    url: document.location.href, 
    sourceId: "201609131738",
    productKey: "97dc4b8e4aeb41ca8606d2c6efa6eae3",
    target: "cloud-tie-wrapper"
  };
</script>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>


      </article>


      <footer class="site-footer">

          <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?aa2fdee733dec8a2399b5bc0efbfd843";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

        <span class="site-footer-credits"><a href="http://www.ihaiu.com">爱海游</a></span> |
        <span class="site-footer-credits"><a href="http://blog.ihaiu.com">博客</a></span> |

        <script src="http://s4.cnzz.com/z_stat.php?id=1260003113&web_id=1260003113" language="JavaScript"></script>

        <p align="center">版权所有：©2021 ihaiu.com 版权所有ICP证： <a href="https://beian.miit.gov.cn/" target="_blank">沪ICP备2021002336号</a></p>
      </footer>

    </section>


  
  </body>
</html>


